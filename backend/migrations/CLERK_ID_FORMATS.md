# Clerk ID Format Reference

**Quick reference for developers working with Clerk-integrated SaaS X-Ray database**

---

## ID Format Standards

### Organization IDs (from Clerk)
- **Format**: `org_[alphanumeric]`
- **Example**: `org_33aku5ITMpEIFi3PTxFXTew8jMb`
- **Source**: Provided by Clerk authentication
- **Type**: `VARCHAR(255)`
- **Validation**: `/^org_[a-zA-Z0-9]+$/`

### Platform Connection IDs (application-generated)
- **Format**: `[platform]-[timestamp]`
- **Example**: `google-1759566567402`
- **Source**: Generated by backend when OAuth connection is created
- **Type**: `VARCHAR(255)`
- **Validation**: `/^[a-z]+-[0-9]+$/`

### Credential IDs (application-generated)
- **Format**: `cred-[descriptor]-[number]`
- **Example**: `cred-clerk-test-001`
- **Source**: Generated by backend when storing OAuth credentials
- **Type**: `VARCHAR(255)`
- **Validation**: `/^cred-[a-z]+-[0-9]+$/`

---

## Database Schema Reference

### Primary Keys Using String IDs
```sql
organizations.id              VARCHAR(255)  -- Clerk organization ID
platform_connections.id       VARCHAR(255)  -- App-generated connection ID
encrypted_credentials.id      VARCHAR(255)  -- App-generated credential ID
```

### Foreign Keys Using String IDs
```sql
-- References organizations.id
*.organization_id             VARCHAR(255)

-- References platform_connections.id
*.platform_connection_id      VARCHAR(255)
```

### Tables Still Using UUIDs
These tables use UUIDs for their primary keys (not Clerk-related):
- `audit_logs.id`
- `automation_activities.id`
- `compliance_mappings.id`
- `cross_platform_integrations.id`
- `discovered_automations.id`
- `discovery_runs.id`
- `risk_assessments.id`

---

## TypeScript Type Updates

### Before Migration (UUID)
```typescript
interface Organization {
  id: uuid;
  name: string;
}

interface PlatformConnection {
  id: uuid;
  organization_id: uuid;
}
```

### After Migration (String)
```typescript
interface Organization {
  id: string;  // Clerk format: org_xxxxx
  name: string;
}

interface PlatformConnection {
  id: string;  // App format: platform-timestamp
  organization_id: string;  // Clerk format: org_xxxxx
}
```

---

## Code Examples

### Creating an Organization (Clerk-integrated)
```typescript
// Organization ID comes from Clerk
const clerkOrgId = session.organization.id;  // "org_33aku5ITMpEIFi3PTxFXTew8jMb"

await db.query(`
  INSERT INTO organizations (id, name, domain)
  VALUES ($1, $2, $3)
`, [clerkOrgId, orgName, domain]);
```

### Creating a Platform Connection
```typescript
// Generate connection ID
const connectionId = `${platform}-${Date.now()}`;  // "google-1759566567402"

await db.query(`
  INSERT INTO platform_connections (id, organization_id, platform_type)
  VALUES ($1, $2, $3)
`, [connectionId, clerkOrgId, platform]);
```

### Creating Encrypted Credentials
```typescript
// Generate credential ID
const credentialId = `cred-${platform}-${Date.now()}`;  // "cred-google-001"

await db.query(`
  INSERT INTO encrypted_credentials (id, platform_connection_id, credential_type)
  VALUES ($1, $2, $3)
`, [credentialId, connectionId, 'access_token']);
```

---

## Validation Utilities

### TypeScript Validators
```typescript
// Validate Clerk organization ID
function isValidClerkOrgId(id: string): boolean {
  return /^org_[a-zA-Z0-9]+$/.test(id);
}

// Validate platform connection ID
function isValidConnectionId(id: string): boolean {
  return /^[a-z]+-[0-9]+$/.test(id);
}

// Validate credential ID
function isValidCredentialId(id: string): boolean {
  return /^cred-[a-z]+-[0-9]+$/.test(id);
}
```

### PostgreSQL Check Constraints (Optional)
```sql
-- Add validation constraints to ensure ID format integrity
ALTER TABLE organizations
  ADD CONSTRAINT organizations_id_format_check
  CHECK (id ~ '^org_[a-zA-Z0-9]+$');

ALTER TABLE platform_connections
  ADD CONSTRAINT connections_id_format_check
  CHECK (id ~ '^[a-z]+-[0-9]+$');
```

---

## Migration Testing Checklist

### Database Tests
- [x] Organizations table accepts Clerk IDs
- [x] Platform connections table accepts custom IDs
- [x] Foreign key relationships work with string IDs
- [x] ON DELETE CASCADE works correctly
- [x] All triggers handle string IDs correctly

### Backend Tests
- [ ] TypeScript compilation passes with string types
- [ ] Repository layer uses string IDs correctly
- [ ] OAuth flow generates valid connection IDs
- [ ] Credential storage uses string IDs
- [ ] API endpoints accept/return string IDs

### Frontend Tests
- [ ] Clerk authentication provides organization ID
- [ ] UI displays string IDs correctly
- [ ] API calls use string IDs in requests
- [ ] Connection creation flow works end-to-end

### Integration Tests
- [ ] Complete OAuth flow with Clerk auth
- [ ] Organization creation via Clerk webhook
- [ ] Connection management with string IDs
- [ ] Discovery runs with Clerk organizations
- [ ] Audit logging with string IDs

---

## Common Pitfalls

### ❌ Don't Do This
```typescript
// DON'T try to generate UUIDs for organizations
const orgId = uuid.v4();  // WRONG! Use Clerk's org ID

// DON'T use UUID validation
if (!isUuid(organizationId)) {  // WRONG! IDs are strings now
```

### ✅ Do This Instead
```typescript
// USE Clerk's organization ID
const orgId = clerk.organization.id;  // "org_xxxxx"

// USE string validation
if (!isValidClerkOrgId(organizationId)) {
  throw new Error('Invalid organization ID format');
}
```

---

## FAQ

**Q: Can I still use UUIDs for internal record IDs?**
A: Yes! Tables like `audit_logs`, `discovered_automations`, etc. still use UUIDs for their primary keys. Only organization and connection IDs are strings.

**Q: What happens if a Clerk organization is deleted?**
A: The database has `ON DELETE CASCADE` on all `organization_id` foreign keys, so all related records will be automatically deleted.

**Q: How do I generate a connection ID?**
A: Use the format `${platform}-${Date.now()}`, for example: `google-1759566567402`

**Q: Can I change an existing UUID-based system to Clerk IDs?**
A: Yes, but you'll need to migrate existing data. The migration scripts in this directory show how to do this safely.

**Q: What if Clerk changes their ID format?**
A: The database uses `VARCHAR(255)` which is flexible enough to handle format changes. Update your validation regex if needed.

---

## Support

For questions about this migration:
1. Review `/backend/migrations/MIGRATION_RESULTS.md`
2. Check `/backend/migrations/CLERK_MIGRATION_SUMMARY.md`
3. Examine migration SQL files in this directory
4. Contact the backend team for assistance
